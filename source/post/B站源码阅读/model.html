<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>B站源码阅读-model | mini-bilibili</title>
    <meta name="description" content="低仿B站">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.dcd73214.css" as="style"><link rel="preload" href="/assets/js/app.90430322.js" as="script"><link rel="preload" href="/assets/js/2.1d78d93b.js" as="script"><link rel="preload" href="/assets/js/8.832b17ef.js" as="script"><link rel="prefetch" href="/assets/js/10.fdd73572.js"><link rel="prefetch" href="/assets/js/3.0cfbad14.js"><link rel="prefetch" href="/assets/js/4.7a4d83b2.js"><link rel="prefetch" href="/assets/js/5.954045cc.js"><link rel="prefetch" href="/assets/js/6.b39537c4.js"><link rel="prefetch" href="/assets/js/7.170b57b7.js"><link rel="prefetch" href="/assets/js/9.30f76b7c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dcd73214.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">mini-bilibili</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go-common Menu" class="dropdown-title"><span class="title">B站源码阅读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/authSvc-User.html" class="nav-link">
  用户认证中间件
</a></li><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/api.html" class="nav-link">
  api
</a></li><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/model.html" class="nav-link">
  model
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="go-common Menu" class="dropdown-title"><span class="title">B站源码阅读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/authSvc-User.html" class="nav-link">
  用户认证中间件
</a></li><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/api.html" class="nav-link">
  api
</a></li><li class="dropdown-item"><!----> <a href="/source/post/B站源码阅读/model.html" class="nav-link">
  model
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>B站源码阅读-model</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#弹幕" class="sidebar-link">弹幕</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#弹幕index和content" class="sidebar-link">弹幕index和content</a></li><li class="sidebar-sub-header"><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#弹幕举报" class="sidebar-link">弹幕举报</a></li></ul></li><li><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#动态" class="sidebar-link">动态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#动态卡片dycard" class="sidebar-link">动态卡片DyCard</a></li></ul></li><li><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#关注和粉丝" class="sidebar-link">关注和粉丝</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#模板" class="sidebar-link">模板</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/post/B%E7%AB%99%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/model.html#模板-2" class="sidebar-link">模板</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这个文档是对B站源码model的归纳整理，随着时间的推移可能和最新代码有出入...<br>
源码日期：2019年4月<br>
整理日期：2020年4月起</p></div> <p>[TOC]</p> <h2 id="弹幕"><a href="#弹幕" class="header-anchor">#</a> 弹幕</h2> <h3 id="弹幕index和content"><a href="#弹幕index和content" class="header-anchor">#</a> 弹幕index和content</h3> <p><strong>model位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/interface/main/dm2/model/dm.pb.go-39行</span>
<span class="token keyword">type</span> DM <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID         <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,1,opt,name=ID,proto3&quot; json:&quot;id&quot;`</span>
  Type       <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,2,opt,name=Type,proto3&quot; json:&quot;type&quot;`</span>
  Oid        <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,3,opt,name=Oid,proto3&quot; json:&quot;oid&quot;`</span>
  Mid        <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,4,opt,name=Mid,proto3&quot; json:&quot;mid&quot;`</span>
  Progress   <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,5,opt,name=Progress,proto3&quot; json:&quot;progress&quot;`</span>
  Pool       <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,6,opt,name=Pool,proto3&quot; json:&quot;pool&quot;`</span>
  Attr       <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,7,opt,name=Attr,proto3&quot; json:&quot;attr&quot;`</span>
  State      <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,8,opt,name=State,proto3&quot; json:&quot;state&quot;`</span>
  Ctime      go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,9,opt,name=Ctime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;ctime&quot;`</span>
  Mtime      go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,10,opt,name=Mtime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;mtime&quot;`</span>
  Content    <span class="token operator">*</span>Content                    <span class="token string">`protobuf:&quot;bytes,11,opt,name=Content&quot; json:&quot;content,omitempty&quot;`</span>
  ContentSpe <span class="token operator">*</span>ContentSpecial             <span class="token string">`protobuf:&quot;bytes,12,opt,name=ContentSpe&quot; json:&quot;content_special,omitempty&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 弹幕内容</span>
<span class="token keyword">type</span> Content <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID       <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,1,opt,name=ID,proto3&quot; json:&quot;id&quot;`</span>
  FontSize <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,2,opt,name=FontSize,proto3&quot; json:&quot;fontsize&quot;`</span>
  Color    <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,3,opt,name=Color,proto3&quot; json:&quot;color&quot;`</span>
  Mode     <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,4,opt,name=Mode,proto3&quot; json:&quot;mode&quot;`</span>
  IP       <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,5,opt,name=IP,proto3&quot; json:&quot;ip&quot;`</span>
  Plat     <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,6,opt,name=Plat,proto3&quot; json:&quot;plat&quot;`</span>
  Msg      <span class="token builtin">string</span>                      <span class="token string">`protobuf:&quot;bytes,7,opt,name=Msg,proto3&quot; json:&quot;msg&quot;`</span>
  Ctime    go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,8,opt,name=Ctime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;ctime&quot;`</span>
  Mtime    go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,9,opt,name=Mtime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;mtime&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>数据库分表以及sql位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/interface/main/dm2/dao/mysql.go——18行：查询弹幕index和content</span>
_pageSize             <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment">// 一个xml最多1000条弹幕</span>
_subjectSharding      <span class="token operator">=</span> <span class="token number">100</span>
_indexSharding        <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment">// 弹幕index表分表数</span>
_contentSharding      <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment">// 弹幕内容表分表数</span>
_idxByidSQL           <span class="token operator">=</span> <span class="token string">&quot;SELECT id,type,oid,mid,progress,state,pool,attr,ctime,mtime FROM dm_index_%03d WHERE type=? AND id=?&quot;</span>
_idxsByidSQL          <span class="token operator">=</span> <span class="token string">&quot;SELECT id,type,oid,mid,progress,state,pool,attr,ctime,mtime FROM dm_index_%03d WHERE type=? AND id IN(%s)&quot;</span>
_getIndexSQL          <span class="token operator">=</span> <span class="token string">&quot;SELECT id,type,oid,mid,progress,state,pool,attr,ctime,mtime FROM dm_index_%03d WHERE type=? AND oid=? AND state IN(0,6)&quot;</span>
_getContentSQL        <span class="token operator">=</span> <span class="token string">&quot;SELECT dmid,fontsize,color,mode,ip,plat,msg,ctime,mtime FROM dm_content_%03d WHERE dmid=?&quot;</span>
_contentsSQL          <span class="token operator">=</span> <span class="token string">&quot;SELECT dmid,fontsize,color,mode,ip,plat,msg,ctime,mtime FROM dm_content_%03d WHERE dmid IN(%s)&quot;</span>

<span class="token comment">// app/job/main/dm2/dao/mysql.go——28行：弹幕数据通过异步job入库</span>
_addIndexSQL        <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO dm_index_%03d(id,type,oid,mid,progress,state,pool,attr,ctime) VALUES(?,?,?,?,?,?,?,?,?)&quot;</span>
_addContentSQL      <span class="token operator">=</span> <span class="token string">&quot;REPLACE INTO dm_content_%03d(dmid,fontsize,color,mode,ip,plat,msg,ctime) VALUES(?,?,?,?,?,?,?,?)&quot;</span>
</code></pre></div><h3 id="弹幕举报"><a href="#弹幕举报" class="header-anchor">#</a> 弹幕举报</h3> <p><strong>model位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	ReportReason <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int8</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token number">1</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及违禁相关&quot;</span><span class="token punctuation">,</span>
		<span class="token number">2</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及非法网站信息&quot;</span><span class="token punctuation">,</span>
		<span class="token number">3</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及赌博诈骗信息&quot;</span><span class="token punctuation">,</span>
		<span class="token number">4</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及人身攻击&quot;</span><span class="token punctuation">,</span>
		<span class="token number">5</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及侵犯他人隐私&quot;</span><span class="token punctuation">,</span>
		<span class="token number">6</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及垃圾广告&quot;</span><span class="token punctuation">,</span>
		<span class="token number">7</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及引战&quot;</span><span class="token punctuation">,</span>
		<span class="token number">8</span><span class="token punctuation">:</span>  <span class="token string">&quot;内容涉及视频剧透&quot;</span><span class="token punctuation">,</span>
		<span class="token number">9</span><span class="token punctuation">:</span>  <span class="token string">&quot;恶意刷屏&quot;</span><span class="token punctuation">,</span>
		<span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">&quot;视频不相关&quot;</span><span class="token punctuation">,</span>
		<span class="token number">11</span><span class="token punctuation">:</span> <span class="token string">&quot;其他&quot;</span><span class="token punctuation">,</span>
		<span class="token number">12</span><span class="token punctuation">:</span> <span class="token string">&quot;青少年不良信息&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	RptMsgTitle    <span class="token operator">=</span> <span class="token string">&quot;举报处理结果通知&quot;</span>
	RptMsgTemplate <span class="token operator">=</span> <span class="token string">`您好，您在视频#{%s}{&quot;http://www.bilibili.com/av%d&quot;}中举报的弹幕『%s』已被删除，原因是『%s』，感谢您对bilibili社区秩序的维护，哔哩哔哩 (゜-゜)つロ 干杯~`</span>
<span class="token punctuation">)</span>

<span class="token comment">// const var</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// up主操作</span>
	StatUpperInit   <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// up主未处理</span>
	StatUpperIgnore <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// up主已忽略</span>
	StatUpperDelete <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// up主已删除</span>

	<span class="token comment">// 管理员操作</span>
	StatFirstInit        <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 待一审</span>
	StatFirstDelete      <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 一审删除</span>
	StatSecondInit       <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 待二审</span>
	StatSecondIgnore     <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 二审忽略</span>
	StatSecondDelete     <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 二审删除</span>
	StatFirstIgnore      <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 一审忽略</span>
	StatSecondAutoDelete <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment">// 二审脚本删除</span>
	<span class="token comment">// 处理结果通知</span>
	NoticeUnsend <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 未通知用户</span>
	NoticeSend   <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 已通知用户</span>

	<span class="token comment">// 举报原因</span>
	ReportReasonProhibited  <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 违禁</span>
	ReportReasonPorn        <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">// 色情</span>
	ReportReasonFraud       <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">// 赌博诈骗</span>
	ReportReasonAttack      <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment">// 人身攻击</span>
	ReportReasonPrivate     <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">// 隐私</span>
	ReportReasonAd          <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token comment">// 广告</span>
	ReportReasonWar         <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>  <span class="token comment">// 引战</span>
	ReportReasonSpoiler     <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token comment">// 剧透</span>
	ReportReasonMeaningless <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>  <span class="token comment">// 刷屏</span>
	ReportReasonUnrelated   <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 视频不相关</span>
	ReportReasonOther       <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment">// 其他</span>
	ReportReasonTeenagers   <span class="token operator">=</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment">// 青少年不良信息</span>
<span class="token punctuation">)</span>

<span class="token comment">// Report dm report info</span>
<span class="token keyword">type</span> Report <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ID      <span class="token builtin">int64</span>     <span class="token string">`json:&quot;id&quot;`</span>      <span class="token comment">// 主键id</span>
	Cid     <span class="token builtin">int64</span>     <span class="token string">`json:&quot;cid&quot;`</span>     <span class="token comment">// 视频id</span>
	Did     <span class="token builtin">int64</span>     <span class="token string">`json:&quot;dmid&quot;`</span>    <span class="token comment">// 弹幕id</span>
	UID     <span class="token builtin">int64</span>     <span class="token string">`json:&quot;uid&quot;`</span>     <span class="token comment">// 举报用户的id</span>
	Reason  <span class="token builtin">int8</span>      <span class="token string">`json:&quot;reason&quot;`</span>  <span class="token comment">// 举报原因类型</span>
	Content <span class="token builtin">string</span>    <span class="token string">`json:&quot;content&quot;`</span> <span class="token comment">// 举报内容：reason为其它时有值</span>
	Count   <span class="token builtin">int64</span>     <span class="token string">`json:&quot;count&quot;`</span>   <span class="token comment">// 被举报次数</span>
	State   <span class="token builtin">int8</span>      <span class="token string">`json:&quot;state&quot;`</span>   <span class="token comment">// 举报状态</span>
	UpOP    <span class="token builtin">int8</span>      <span class="token string">`json:&quot;up_op&quot;`</span>   <span class="token comment">// up主操作</span>
	Score   <span class="token builtin">int32</span>     <span class="token string">`json:&quot;score&quot;`</span>   <span class="token comment">// 举报分</span>
	RpTime  time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;rp_time&quot;`</span> <span class="token comment">// 举报时间</span>
	Ctime   time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;ctime&quot;`</span>   <span class="token comment">// 插入时间</span>
	Mtime   time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;mtime&quot;`</span>   <span class="token comment">// 更新时间</span>
<span class="token punctuation">}</span>

<span class="token comment">// User report user info</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ID      <span class="token builtin">int64</span>     <span class="token string">`json:&quot;id&quot;`</span>
	Did     <span class="token builtin">int64</span>     <span class="token string">`json:&quot;dmid&quot;`</span>
	UID     <span class="token builtin">int64</span>     <span class="token string">`json:&quot;uid&quot;`</span>
	Reason  <span class="token builtin">int8</span>      <span class="token string">`json:&quot;reason&quot;`</span>
	State   <span class="token builtin">int8</span>      <span class="token string">`json:&quot;state&quot;`</span>
	Content <span class="token builtin">string</span>    <span class="token string">`json:&quot;content&quot;`</span>
	Ctime   time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;ctime&quot;`</span>
	Mtime   time<span class="token punctuation">.</span>Time <span class="token string">`json:&quot;mtime&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>数据库分表以及sql位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/interface/main/dm/dao/mysql_report.go</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	_rptSharding     <span class="token operator">=</span> <span class="token number">100</span>
	_rptUserSharding <span class="token operator">=</span> <span class="token number">100</span>
	_rptLogSharding  <span class="token operator">=</span> <span class="token number">100</span>
	_insertRpt       <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO dm_report_%d (cid,dmid,uid,reason,content,count,state,up_op,rp_time,score,ctime,mtime) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)&quot;</span> <span class="token operator">+</span>
		<span class="token string">&quot; ON DUPLICATE KEY UPDATE uid=?,reason=?,state=?,content=?,count=count+1,rp_time=?,score=score+?&quot;</span>
	_selectRpt         <span class="token operator">=</span> <span class="token string">&quot;SELECT id,cid,dmid,uid,reason,content,count,state,up_op,score,rp_time,ctime,mtime FROM dm_report_%d WHERE dmid=?&quot;</span>
	_updateRptUPOp     <span class="token operator">=</span> <span class="token string">&quot;UPDATE dm_report_%d SET up_op=? WHERE dmid=?&quot;</span>
	_updateRpt         <span class="token operator">=</span> <span class="token string">&quot;UPDATE dm_report_%d SET state=? WHERE dmid=?&quot;</span>
	_insertUser        <span class="token operator">=</span> <span class="token string">&quot;INSERT IGNORE INTO dm_report_user_%d (dmid,uid,reason,state,content,ctime,mtime) VALUES(?,?,?,?,?,?,?)&quot;</span>
	_selectRptLog      <span class="token operator">=</span> <span class="token string">&quot;SELECT id,dmid,adminid,reason,result,remark,elapsed,ctime,mtime FROM dm_report_admin_log_%d WHERE dmid=? ORDER BY mtime&quot;</span>
	_insertRptLog      <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO dm_report_admin_log_%d (dmid,adminid,reason,result,remark,elapsed) VALUES (?,?,?,?,?,?)&quot;</span>
	_selectRptUser     <span class="token operator">=</span> <span class="token string">&quot;SELECT id,dmid,uid,reason,state,ctime,mtime FROM dm_report_user_%d WHERE dmid=? AND state=?&quot;</span>
	_updateRptUserStat <span class="token operator">=</span> <span class="token string">&quot;UPDATE dm_report_user_%d SET state=? WHERE dmid=? AND state!=?&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="动态"><a href="#动态" class="header-anchor">#</a> 动态</h2> <h3 id="动态卡片dycard"><a href="#动态卡片dycard" class="header-anchor">#</a> 动态卡片DyCard</h3> <p><strong>model位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/interface/main/space/model/dynamic.go-11行</span>
<span class="token keyword">type</span> DyCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Card json<span class="token punctuation">.</span>RawMessage <span class="token string">`json:&quot;card&quot;`</span>
	Desc <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		UID         <span class="token builtin">int64</span>        <span class="token string">`json:&quot;uid&quot;`</span>
		Type        <span class="token builtin">int</span>          <span class="token string">`json:&quot;type&quot;`</span>
		ACL         <span class="token builtin">int</span>          <span class="token string">`json:&quot;acl&quot;`</span>
		Rid         <span class="token builtin">int64</span>        <span class="token string">`json:&quot;rid&quot;`</span>
		View        <span class="token builtin">int32</span>        <span class="token string">`json:&quot;view&quot;`</span>
		Repost      <span class="token builtin">int32</span>        <span class="token string">`json:&quot;repost&quot;`</span>
		Comment     <span class="token builtin">int32</span>        <span class="token string">`json:&quot;comment&quot;`</span>
		Like        <span class="token builtin">int32</span>        <span class="token string">`json:&quot;like&quot;`</span>
		IsLiked     <span class="token builtin">int32</span>        <span class="token string">`json:&quot;is_liked&quot;`</span>
		DynamicID   <span class="token builtin">int64</span>        <span class="token string">`json:&quot;dynamic_id&quot;`</span>
		CommentID   <span class="token builtin">int64</span>        <span class="token string">`json:&quot;comment_id&quot;`</span>
		Timestamp   <span class="token builtin">int64</span>        <span class="token string">`json:&quot;timestamp&quot;`</span>
		PreDyID     <span class="token builtin">int64</span>        <span class="token string">`json:&quot;pre_dy_id&quot;`</span>
		OrigDyID    <span class="token builtin">int64</span>        <span class="token string">`json:&quot;orig_dy_id&quot;`</span>
		OrigType    <span class="token builtin">int</span>          <span class="token string">`json:&quot;orig_type&quot;`</span>
		RType       <span class="token builtin">int</span>          <span class="token string">`json:&quot;r_type&quot;`</span>
		InnerID     <span class="token builtin">int64</span>        <span class="token string">`json:&quot;inner_id&quot;`</span>
		UserProfile <span class="token operator">*</span>UserProfile <span class="token string">`json:&quot;user_profile,omitempty&quot;`</span>
	<span class="token punctuation">}</span> <span class="token string">`json:&quot;desc&quot;`</span>
	Extension <span class="token operator">*</span>DyExtension <span class="token string">`json:&quot;extension,omitempty&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>数据库分表以及sql位置</strong></p> <p>未找到</p> <h2 id="关注和粉丝"><a href="#关注和粉丝" class="header-anchor">#</a> 关注和粉丝</h2> <p><strong>model位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/service/main/relation/model/model.pb.go——235行</span>
<span class="token keyword">type</span> Following <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Mid                  <span class="token builtin">int64</span>                       <span class="token string">`protobuf:&quot;varint,1,opt,name=mid,proto3&quot; json:&quot;mid&quot;`</span>
	Attribute            <span class="token builtin">uint32</span>                      <span class="token string">`protobuf:&quot;varint,2,opt,name=attribute,proto3&quot; json:&quot;attribute&quot;`</span>
	Source               <span class="token builtin">uint32</span>                      <span class="token string">`protobuf:&quot;varint,3,opt,name=source,proto3&quot; json:&quot;-&quot;`</span>
	CTime                go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,4,opt,name=ctime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;-&quot;`</span>
	MTime                go_common_library_time<span class="token punctuation">.</span>Time <span class="token string">`protobuf:&quot;varint,5,opt,name=mtime,proto3,casttype=go-common/library/time.Time&quot; json:&quot;mtime&quot;`</span>
	Tag                  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span>                     <span class="token string">`protobuf:&quot;varint,6,rep,packed,name=tag,proto3&quot; json:&quot;tag&quot;`</span>
	Special              <span class="token builtin">int32</span>                       <span class="token string">`protobuf:&quot;varint,7,opt,name=special,proto3&quot; json:&quot;special&quot;`</span>
	XXX_NoUnkeyedLiteral <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token string">`json:&quot;-&quot;`</span>
	XXX_unrecognized     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>                      <span class="token string">`json:&quot;-&quot;`</span>
	XXX_sizecache        <span class="token builtin">int32</span>                       <span class="token string">`json:&quot;-&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>数据库分表以及sql位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// app/service/main/relation/dao/mysql.go</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	_shard        <span class="token operator">=</span> <span class="token number">500</span>
	_statShard    <span class="token operator">=</span> <span class="token number">50</span>
	_tagShard     <span class="token operator">=</span> <span class="token number">100</span>
	_tagUserShard <span class="token operator">=</span> <span class="token number">500</span>
	_defaultTag   <span class="token operator">=</span> <span class="token string">&quot;默认分组&quot;</span>
	_specialTag   <span class="token operator">=</span> <span class="token string">&quot;特别关注&quot;</span>
	<span class="token comment">// relation</span>
	_getFollowingSQL   <span class="token operator">=</span> <span class="token string">&quot;SELECT fid,attribute,mtime FROM user_relation_mid_%03d WHERE mid=? AND status=0&quot;</span>
	_getFollowingInSQL <span class="token operator">=</span> <span class="token string">&quot;SELECT fid,attribute,mtime FROM user_relation_mid_%03d WHERE mid=? AND status=0 AND fid IN (%s)&quot;</span>
	_addFollowingSQL   <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_relation_mid_%03d (mid,fid,attribute,source,status, ctime,mtime) VALUES (?,?,?,?,0,?,?) ON DUPLICATE KEY UPDATE attribute=attribute|?,source=?,status=0,mtime=?&quot;</span>
	_setFollowingSQL   <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_mid_%03d SET attribute=?,source=?,status=?,mtime=? WHERE mid=? AND fid=?&quot;</span>
	_getFollowersSQL   <span class="token operator">=</span> <span class="token string">&quot;SELECT mid,attribute,mtime FROM user_relation_fid_%03d WHERE fid=? AND status=0 AND attribute IN (2,6) ORDER BY mtime DESC LIMIT 1000&quot;</span>
	_addFollowersSQL   <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_relation_fid_%03d (mid,fid,attribute,source,status,ctime,mtime) VALUES (?,?,?,?,0,?,?) ON DUPLICATE KEY UPDATE attribute=attribute|?,source=?,status=0,mtime=?&quot;</span>
	_setFollowersSQL   <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_fid_%03d SET attribute=?,source=?,status=?,mtime=? WHERE fid=? AND mid=?&quot;</span>
	_getRelationSQL    <span class="token operator">=</span> <span class="token string">&quot;SELECT attribute FROM user_relation_mid_%03d WHERE mid=? AND fid=? AND status=0 LIMIT 1&quot;</span>
	_addStatIgnoreSQL  <span class="token operator">=</span> <span class="token string">&quot;INSERT IGNORE INTO user_relation_stat_%02d (mid,following,whisper,black,follower,ctime,mtime) VALUES (?,?,?,?,?,?,?)&quot;</span>
	_addStatSQL        <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_stat_%02d SET following=following+?,whisper=whisper+?,black=black+?,follower=follower+?,mtime=? WHERE mid=?&quot;</span>
	_setStatSQL        <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_stat_%02d SET following=?,whisper=?,black=?,follower=?,mtime=? WHERE mid=?&quot;</span>
	_getStatSQL        <span class="token operator">=</span> <span class="token string">&quot;SELECT mid,following,whisper,black,follower, ctime,mtime from user_relation_stat_%02d where mid=?&quot;</span>
	_getTxStatSQL      <span class="token operator">=</span> <span class="token string">&quot;SELECT mid,following,whisper,black,follower,ctime,mtime from user_relation_stat_%02d where mid=? FOR UPDATE&quot;</span>
	<span class="token comment">// relation tag table</span>
	_getTagsSQL    <span class="token operator">=</span> <span class="token string">&quot;SELECT id,name,status,mtime FROM user_relation_tag_%02d WHERE mid=? AND status=0&quot;</span>
	_addTagSQL     <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_relation_tag_%02d (mid,name,status,ctime,mtime) VALUES (?,?,0,?,?)&quot;</span>
	_delTagSQL     <span class="token operator">=</span> <span class="token string">&quot;DELETE FROM user_relation_tag_%02d WHERE id=? AND mid=?&quot;</span>
	_setTagNameSQL <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_tag_%02d SET name=?,mtime=? WHERE id=?&quot;</span>
	<span class="token comment">// relation tag user table</span>
	_getTagUserSQL      <span class="token operator">=</span> <span class="token string">&quot;SELECT fid,tag FROM user_relation_tag_user_%03d WHERE mid=?&quot;</span>
	_getUsersTagSQL     <span class="token operator">=</span> <span class="token string">&quot;SELECT fid,tag FROM user_relation_tag_user_%03d WHERE mid=? AND fid IN(%s)&quot;</span>
	_getTagsByMidFidSQL <span class="token operator">=</span> <span class="token string">&quot;SELECT fid,tag,mtime FROM user_relation_tag_user_%03d WHERE mid=? and fid=?&quot;</span>
	_addTagUserSQL      <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_relation_tag_user_%03d (mid,fid,tag,ctime,mtime) VALUES (?,?,?,?,?) ON DUPLICATE KEY UPDATE tag=?&quot;</span>
	_setTagUserSQL      <span class="token operator">=</span> <span class="token string">&quot;UPDATE user_relation_tag_user_%03d SET tag=?,mtime=? WHERE mid=? AND fid=?&quot;</span>
	_delTagUserSQL      <span class="token operator">=</span> <span class="token string">&quot;DELETE FROM user_relation_tag_user_%03d WHERE mid=? AND fid=?&quot;</span>
	<span class="token comment">// relation monitor</span>
	_loadMonitorSQL <span class="token operator">=</span> <span class="token string">&quot;SELECT mid FROM user_relation_monitor&quot;</span>
	_addMonitorSQL  <span class="token operator">=</span> <span class="token string">&quot;INSERT IGNORE INTO user_relation_monitor (mid,ctime,mtime) VALUES (?,?,?)&quot;</span>
	_delMonitorSQL  <span class="token operator">=</span> <span class="token string">&quot;DELETE FROM user_relation_monitor WHERE mid = ?&quot;</span>
	<span class="token comment">// relation achieve</span>
	_hasReachAchieve <span class="token operator">=</span> <span class="token string">&quot;SELECT count(1) FROM user_addit WHERE mid=? AND achieve_flags&gt;=?&quot;</span>
	<span class="token comment">// follower notify</span>
	_getFollowerNotifySettingSQL <span class="token operator">=</span> <span class="token string">&quot;SELECT disable_follower_notify FROM user_addit where mid=?&quot;</span>
	_enableFollowerNotifySQL     <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_addit (mid, disable_follower_notify) VALUES(?, 0) ON DUPLICATE KEY UPDATE disable_follower_notify=0&quot;</span>
	_disableFollowerNotifySQL    <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO user_addit (mid, disable_follower_notify) VALUES(?, 1) ON DUPLICATE KEY UPDATE disable_follower_notify=1&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// Followers get user's latest 1000 followers(attribute = AttrFollowing), order by mtime desc.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">Followers</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> mid <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>res <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Following<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows
	<span class="token keyword">if</span> rows<span class="token punctuation">,</span> err <span class="token operator">=</span> d<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>_getFollowersSQL<span class="token punctuation">,</span> <span class="token function">hit</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;d.query(%s).hit(%d).mid(%d) error(%v)&quot;</span><span class="token punctuation">,</span> _getFollowersSQL<span class="token punctuation">,</span> <span class="token function">hit</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>Following<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">.</span>Mid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">.</span>Attribute<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">.</span>MTime<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;row.Scan() error(%v)&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			res <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		res <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="模板"><a href="#模板" class="header-anchor">#</a> 模板</h2> <h3 id="模板-2"><a href="#模板-2" class="header-anchor">#</a> 模板</h3> <p><strong>model位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code>
</code></pre></div><p><strong>数据库分表以及sql位置</strong></p> <div class="language-go extra-class"><pre class="language-go"><code>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.90430322.js" defer></script><script src="/assets/js/2.1d78d93b.js" defer></script><script src="/assets/js/8.832b17ef.js" defer></script>
  </body>
</html>
